import Page from "@reason/pages/Docs";
export default Page({ title: "Scan State" });

# Scan State

Scan state - это структура данных, которая позволяет разграничить производство SNARK-транзакций производителей блоков и снарк-воркеров.

Поскольку производителям блоков больше не нужно проводить SNARK-транзакции, время производства блока может оставаться постоянным независимо от пропускной способности транзакции. Кроме того, scan state позволяет распараллеливание генерации доказательств SNARK-транзакций и выполнение ее несколькими конкурирующими [снарк-воркерами](/docs/architecture/snark-workers).

Scan state это лес, состоящий из [полных бинарных деревьев,](https://en.wikipedia.org/wiki/Binary_tree) где каждая нода на дереве - это задача, которую должен выполнить снарк-воркер. Время от времени scan state возвращает одно доказательство с верхушки дерева для подтверждения правильность всех транзакции в основе дерева.

Производители блоков включают доказательства реестра в SNARK блокчейн, который они генерируют, что доказывает валидность текущего состояния цепочки и подтверждает достоверность всех транзакций в снарк реестре.

Как результат, время производства блока может оставаться постоянным независимо от пропускной способности транзакции, при этом структура scan state способна приспосабливаться в соответствии с желаемой пропускной способностью транзакции.

<Alert>

В устойчивом состоянии, когда все слоты заполнены и все необходимые доказательства выполнены, с каждым блоком будет производиться подтверждение реестра.

</Alert>

### Добавление транзакций

При построении блока, [производитель блока](/docs/architecture/block-producers) может включать максимальное количество транзакций, обозначенное [scan state константами](#scan-state-constants). Добавляя транзакции, он может выбирать любую доступную комиссию за транзакции и выплачивать себе вознаграждение в монетах. Каждая добавленная транзакция преобразуется в новые базовые задачи и добавляется в scan state.

Для каждой добавленной транзакции производитель блоков должен включить эквивалентное количество завершенной снарк работы, соответствующее череде заданий, которые уже существуют в scan state.  При добавлении в scan state, завершенные задачи создают новые задачи слияния. Но в случае с корневой нодой доказательство просто возвращается.

Вместо того, чтобы выполнять работу самостоятельно, производитель блоков может приобрести завершенную работу у любых снарк-воркеров среди ставок, доступных в снарк-пуле.

### Scan state константы 

Следующие константы определяют структуру и поведение scan state: 

- transaction_capacity_log_2
- work_delay

Константа transaction_capacity_log_2 определяет максимальное количество транзакций, которое может быть включено в блок:

```
max_no_of_transactions = 2^{transaction_capacity_log_2}
```

Задержка работы обеспечивает достаточное количество времени на выполнение работы снарк-воркерами. Если готовые доказательства отсутствуют, производитель блока не может добавить какие-либо транзакции. Благодаря отложенному выполнению работы, максимальное количество деревьев, которые могут существовать в scan state определяется следующей формулой:

```
max_number_of_trees = (transaction_capacity_log_2 + 1) * (work_delay + 1) + 1
```

Максимальное количество доказательств, которые могут быть включены в блок, определяется следующей формулой:

```
max_number_of_proofs = 2^{transaction\_capacity_log_2 + 1} - 1
```

Ограничители scan state гарантируют, что для каждого блока может быть выпущено только одно доказательство, и что нода слияния, которая будет обновлена после добавления доказательств, соответствующих ее дочерним элементам, всегда пуста.

Хотя максимальное количество транзакций может быть фиксированным, оно также может динамически регулироваться, чтобы соответствовать пропускной способности транзакции. Таким образом, scan state может обрабатывать неограниченное количество транзакций, правда за счет увеличения (логарифмически) задержки подтверждения транзакции.

### Примеры

Рассмотрим scan state с `max_no_of_transactions = 4`, и `work_delay = 1`. Из этого вытекает, что максимальное количество выполняемой работы может быть равно 7, а максимальное количество деревьев - 7. В **генезисе**, scan state пуста.

<img
  alt="Block 0"
  src="/static/img/docs-images/scan-state/ZJXLozR.png"
  width="350"
/>

**Блок 1**: Производитель блока вносит четыре транзакции в scan state с меткой `B1`. Эти транзакции заполняют основу первого дерева.

<img
  alt="Block 1"
  src="/static/img/docs-images/scan-state/mY4MzW0.png"
  width="350"
/>

**Блок 2**: Во втором блоке производитель блока добавляет еще четыре транзакции (`B2`). Они заполняют основу второго дерева. Доказательств не требуется из-за задержки работы блока 1.

<img
  alt="Block 2"
  src="/static/img/docs-images/scan-state/jzYrmZf.png"
  width="700"
/>

**Блок 3**: В третьем блоке производитель блоков добавляет четыре транзакции `B3` к третьему дереву, и должен включать четыре доказательства для первого дерева. В результате включения этих завершенных базовых доказательств создаются две новые задачи слияния `M3`.

<img
  alt="Block 3"
  src="/static/img/docs-images/scan-state/tECFm3I.png"
  width="100%"
/>

<Alert>

`B` или `M` обозначают базовое задачи или задачи слияния, а число указывает порядок добавления в scan state.

</Alert>

**Блок 4**: Для четвертого блока производитель блока добавляет еще четыре транзакции (`B4`) в основу четвертого дерева. Они должны включать четыре доказательства, соответствующих работе добавленной в блоке 2. Опять таки, как результат создаются две задачи слияния `M4`.

<img
  alt="Block 4"
  src="/static/img/docs-images/scan-state/76R2bpU.png"
  width="100%"
/>

<Alert>

Любая незавершенная задача (оранжевый индикатор) - это работа для снарк-воркеров. Снарк-воркеры отправляют завершенную работу в снарк-пул. Задача может быть выполнена несколькими снарк-воркерами, но производители блоков могут приобрести только наименьшую награду в снарк-пуле.

</Alert>

**Блок 5**: В пятый блок добавляются еще четыре транзакции заполняя базу пятого дерева (`B5`), вместе с еще шестью доказательствами (`B3`s and `M3`s). Задачи слияния `M3` вытекают в финальную отсроченную задачу слияния для первого дерева (`M5`).

<img
  alt="Block 5"
  src="/static/img/docs-images/scan-state/QaqfbXG.png"
  width="100%"
/>

**Блок 6**: В шестой блок добавляются еще четыре транзакции (`B6`), заполняя основу шестого дерева. Вносятся еще шесть доказательств (`B4` and `M4`), и создаются три новых задания слияния (`M6`).

<img
  alt="Block 6"
  src="/static/img/docs-images/scan-state/y6dM2FT.png"
  width="100%"
/>

**Блок 7**: В седьмой блок  производитель блоков добавляет еще четыре транзакции (`B7`), заполняя основу седьмого дерева, и это максимальное количество деревьев согласно с указанными константами scan state. Добавляется максимальное количество (7) доказательств (`B5` and `M5`). Эти доказательства создают три новых задания слияния (`M7`), а верхнее доказательство `M5` выводится из scan state.

<img
  alt="Block 7"
  src="/static/img/docs-images/scan-state/RY8umxW.png"
  width="100%"
/>

Доказательство, которое производит первое дерево, является доказательством реестра, которое соответствует транзакциям добавленным в блок 1. Затем содержимое дерева удаляется, чтобы освободить место для дополнительных транзакций.

<img
  alt="Emit proof"
  src="/static/img/docs-images/scan-state/hQvFVfp.png"
  width="100%"
/>

**Блок 8**: В восьмом блоке производитель блоков добавляет две транзакции (`B8`) и включает 4 (`B6`) доказательства. Эти доказательства вытекают в два новых задания слияния (`M8`). Обратите внимание, что для добавления двух транзакций требуется только четыре доказательства.

<img
  alt="Block 8"
  src="/static/img/docs-images/scan-state/A3o18oN.png"
  width="100%"
/>

<Alert>

Работа снарка объединяется в рабочий пакет, обычно содержащий два рабочих идентификатора, за исключением финального корневого доказательства дерева. Пропорциональная работа для транзакции требует два доказательства. Это гарантирует равенство включенных транзакций и приобретаемой работы снарка.

</Alert>

**Block 9**: In the ninth block, the block producer adds three transactions (`B9`). Three proofs (`M6`) are required for the slots to be occupied in the currently unfilled tree. Four proofs were added in the previous block, and therefore only three more needs to be done (given the maximum work is 7). The `M6` proof from tree two is returned as the ledger proof. The third `B9` transaction goes into the now empty tree, and two `B7` proofs are added.

<img
  alt="Block 9"
  src="/static/img/docs-images/scan-state/JGlawxh.png"
  width="100%"
/>

**Block 10**: In block ten, the block producer adds four transactions and, as a result, includes seven proofs (`B7`, `M7`, and two `B8`s).

<img
  alt="Block 10"
  src="/static/img/docs-images/scan-state/kQASfTN.png"
  width="100%"
/>

**Block 11**: In the eleventh block, the block producer adds three transactions (`B11`) and completes five proofs (`B9`, `B9`, `M8`, `M8`, `M9`) in that order. In addition, the `M9` ledger proof is returned from the fourth tree.

<img
  alt="Block 11"
  src="/static/img/docs-images/scan-state/FaVTmWD.png"
  width="100%"
/>

<Alert>

View the contents of the scan state using the `mina advanced snark-job-list` command.

</Alert>

### Integration with the Snark Pool

Newly added jobs to the scan state are pending jobs for snark workers to complete. Snark workers complete the required transaction SNARKs, submitting bids for their completed work. When a node receives and validates the completed work, they will add to their local snark pool if it is valid and the lowest fee for the required work. The work will also be gossiped to other peers in the network.

<Alert>

While multiple snark workers can complete the same work, only the lowest fee is included in the snark pool.

</Alert>

When a block producer includes completed proofs into a block to offset any transactions they add, they may purchase the corresponding work from the snark pool. For example, continuing the example above consider the next block (12). If the block producer wants to add three transactions, comprising a coinbase, a user payment, and a fee transfer to the snark worker, they need to purchase three completed snark work. This corresponds to the 6 `B9`, `B10`s, `M9`, and `M10` (from the seventh tree) proofs, as each snark work includes two _workIds_.

During the time the block is generated, the snark pool may include completed work in addition to the best bids for the required jobs (0.025, 0.165, 0.1 and 0.5) respectively, in the example).

<img
  alt="Submitted work"
  src="/static/img/docs-images/scan-state/fDBZog9.png"
  width="100%"
/>

A block producer will consider the price of available work before selecting transactions. The first transaction a block producer will add will be the coinbase transaction for which there is the coinbase reward. If transaction fees do not cover the snark work fees required for them to be included, they would not be added. A block producer will never purchase work if it is not economical to do so.

In the case where there is no completed snark work available to purchase in the order required, then the corresponding transactions will not be included in a block. This may result in an empty block, but also for the case where no transactions can be added (including a coinbase transaction), there will be no reward for the block producer.

<Alert>

The current snark pool is visible via [GraphQL](/docs/developers/graphql-api) or the CLI via the `mina advanced snark-pool` command.

</Alert>
